---
title: "data exploring"
date: "10/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r load data}
ratings = read_csv("archive/rating.csv")
dim(ratings) %>% knitr::kable()
glimpse(ratings)

ratings %>% count(user_id) %>% nrow()  # 73515 users
ratings %>% count(anime_id) %>% nrow() # 11200 anime 
```



```{r pivot wider}
# drop -1 ratings, for now I thinks it is meaningless
# 6337241 ratings ranging from 1 to 10
ratings_cut = ratings %>% 
  filter(rating != -1) 

ratings_cut %>% count(user_id) %>% nrow()  # 69600 users left
ratings_cut %>% count(anime_id) %>% nrow() # 9927 animes left

# ratings_wide1 = ratings_cut %>% 
#   pivot_wider(names_from = user_id, values_from = rating)

# ratings_wide2 = ratings_cut %>% 
#   group_by(user_id) %>% 
#   mutate(uniid = row_number()) %>% 
#   pivot_wider(names_from = user_id, values_from = rating)

```

```{r}
# try this fancy method
spec1 = ratings_cut %>% 
  build_wider_spec(names_from = user_id, values_from = rating)

ratings_wide3 = ratings_cut %>%
  pivot_wider_spec(spec1)

# rating _wide1 == rating_wide3
```

```{r}
# write_csv
```


```{r}
# sanity check

## id list
users_id = ratings_cut %>% pull(user_id) %>% unique()
animes_id = ratings_cut %>% pull(anime_id) %>% unique()

# small sample check
temp1 = ratings_cut %>% filter(user_id == 3) %>% select(-user_id)
temp2 = ratings_wide3 %>% select(anime_id, 4) %>% remove_missing()
# looks good

length(users_id)
```

```{r}
# large sample check


sanity_check = function() {
  iter = 1
  for (u_id in users_id) {
  cut_temp = ratings_cut %>% filter(user_id == u_id)
  wide_temp = ratings_wide3 %>% select(anime_id, iter + 1) %>% remove_missing()
  anime_id_temp = cut_temp %>% pull(anime_id)
  
  for (a_id in anime_id_temp) {
    
    cut_anime = cut_temp %>% filter(anime_id == a_id) %>% pull(rating)
    wide_anime = wide_temp %>% filter(anime_id == a_id)
    wide_anime1 = wide_anime[1,2]
    wide_anime2 = wide_anime[[1]]
    if (cut_anime == wide_anime1) {
      print(paste("user", u_id, "on anime", a_id, "checked"))
    } else {
      print(paste("user", u_id, "on anime", a_id, "failed match"))
      break
    }
  }
  iter = iter + 1
  }
}

sanity_check()
```


